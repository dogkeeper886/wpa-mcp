# 802.1X EAP-TLS Authentication

**Status:** Proposed (Revision 2)  
**Created:** 2026-01-13  
**Updated:** 2026-01-13

---

## Goal

Add a new `wifi_connect_tls` tool for EAP-TLS certificate-based authentication. This provides mutual authentication without transmitting passwords.

---

## Current State

The `wifi_connect_eap` tool supports PEAP/TTLS password-based authentication but lacks certificate parameters needed for EAP-TLS.

---

## User Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                  Pre-deployment (One-time Setup)                │
│                                                                 │
│  1. Deploy certificates to MCP server:                          │
│     /etc/wpa-mcp/certs/client.crt                              │
│     /etc/wpa-mcp/certs/client.key                              │
│     /etc/wpa-mcp/certs/ca.crt                                  │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                     User Requests Connection                     │
│    wifi_connect_tls(ssid, identity, client_cert_path, ...)     │
└─────────────────────────────┬───────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Validate Parameters                           │
│  - Zod validates required: ssid, identity, cert paths           │
└─────────────────────────────┬───────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                 Configure wpa_supplicant                         │
│  - Set key_mgmt=WPA-EAP                                         │
│  - Set eap=TLS                                                  │
│  - Set identity, client_cert, private_key, ca_cert (paths)     │
└─────────────────────────────┬───────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Enable & Select Network                       │
│                    Wait for COMPLETED state                      │
└─────────────────────────────┬───────────────────────────────────┘
                              │
              ┌───────────────┴───────────────┐
              ▼                               ▼
       ┌────────────┐                  ┌────────────┐
       │  SUCCESS   │                  │   FAILED   │
       │  Get DHCP  │                  │  Return    │
       │  Return IP │                  │  Error     │
       └────────────┘                  └────────────┘
```

---

## Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                         MCP Client                              │
│                  (Claude Desktop / Claude Code)                 │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             │  Pass file paths (fast, small payload)
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│                   wifi_connect_tls Tool                         │
│                                                                 │
│  Parameters:                                                    │
│  ├── ssid                 (network name)                       │
│  ├── identity             (CN from client cert)                │
│  ├── client_cert_path     (path on server)                     │
│  ├── private_key_path     (path on server)                     │
│  ├── ca_cert_path         (path on server)                     │
│  ├── private_key_password (optional, for encrypted keys)       │
│  └── MAC options          (existing randomization support)     │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│                      WpaCli.connectTls()                        │
│                                                                 │
│  wpa_supplicant network configuration:                          │
│  ├── ssid="NetworkName"                                         │
│  ├── key_mgmt=WPA-EAP                                          │
│  ├── eap=TLS                                                   │
│  ├── identity="device.domain.com"                              │
│  ├── client_cert="/etc/wpa-mcp/certs/client.crt"              │
│  ├── private_key="/etc/wpa-mcp/certs/client.key"              │
│  ├── private_key_passwd="keypass" (if encrypted)               │
│  └── ca_cert="/etc/wpa-mcp/certs/ca.crt"                      │
└─────────────────────────────────────────────────────────────────┘
```

---

## Authentication Flow

```
┌──────────────┐                         ┌──────────────┐
│    Client    │                         │RADIUS Server │
│ (wpa_suppl)  │                         │              │
└──────┬───────┘                         └──────┬───────┘
       │                                        │
       │  1. EAP-Identity Request               │
       │<───────────────────────────────────────│
       │                                        │
       │  2. EAP-Identity Response              │
       │     (identity from config)             │
       │───────────────────────────────────────>│
       │                                        │
       │  3. Server Certificate                 │
       │<───────────────────────────────────────│
       │                                        │
       │  4. Validate server cert with ca_cert  │
       │     (prevents MITM attacks)            │
       │                                        │
       │  5. Client Certificate + Signature     │
       │     (client_cert + private_key)        │
       │───────────────────────────────────────>│
       │                                        │
       │  6. Server validates client cert       │
       │     (server has root CA)               │
       │                                        │
       │  7. EAP-Success                        │
       │<───────────────────────────────────────│
       │                                        │
       │  No password transmitted               │
       │  Mutual authentication complete        │
       └────────────────────────────────────────┘
```

---

## Design Decision: Certificate Delivery

MCP server runs remotely. Need to deliver certificates to the server.

### Options Considered

| Option | Description | Pros | Cons |
|--------|-------------|------|------|
| A. PEM content | Pass cert as PEM strings | No pre-deploy | AI slow to generate large params |
| **B. File paths** | Certs pre-deployed on server | Fast, simple, consistent | Manual deploy |
| C. Upload API | Upload endpoint + reference ID | Flexible | Over-engineered |

### Chosen: Option A - PEM Content + Script Helper

Pass certificate content in tool parameters, but use a **script to generate the tool call** instead of AI.

**The Problem with AI-generated PEM:**
- AI takes ~1.5 minutes to format PEM strings into tool call
- The delay is AI thinking time, not network or execution

**The Solution:**
- Script reads cert files and generates complete JSON tool call
- AI just reads the JSON and executes (fast)

**Flow:**

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│  gen-tls-call   │     │    AI Agent     │     │   MCP Server    │
│    (script)     │     │  (Claude Code)  │     │                 │
└────────┬────────┘     └────────┬────────┘     └────────┬────────┘
         │                       │                       │
         │ 1. Generate JSON      │                       │
         │    (instant)          │                       │
         │──────────────────────>│                       │
         │                       │                       │
         │                       │ 2. Read JSON, call    │
         │                       │    tool (fast)        │
         │                       │──────────────────────>│
         │                       │                       │
         │                       │ 3. Write temp files   │
         │                       │ 4. Connect            │
         │                       │ 5. Cleanup            │
         │                       │<──────────────────────│
```

**Rationale (per CLAUDE.md guidelines):**

| Guideline | Assessment |
|-----------|------------|
| **Readability** | ✅ Script is simple, tool params clear |
| **Consistency** | ✅ Same pattern as other tools |
| **Separation of concerns** | ✅ Script handles file I/O, tool handles connection |
| **Error handling** | ✅ Script fails fast if files missing |
| **Observability** | ✅ Log ssid/identity, not cert content |
| **No private info** | ✅ Certs in JSON file, not in AI conversation |

---

## API: wifi_connect_tls

### Parameters

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| ssid | string | Yes | Network SSID |
| identity | string | Yes | Identity (typically CN from client cert) |
| client_cert_pem | string | Yes | PEM-encoded client certificate |
| private_key_pem | string | Yes | PEM-encoded private key |
| ca_cert_pem | string | Yes | PEM-encoded CA certificate |
| private_key_password | string | No | Passphrase for encrypted private key |
| interface | string | No | WiFi interface (default: wlan0) |
| mac_mode | enum | No | MAC randomization mode |
| mac_address | string | No | Specific MAC address |
| preassoc_mac_mode | enum | No | Pre-association MAC mode |
| rand_addr_lifetime | number | No | MAC rotation interval |

### Example

```json
{
  "ssid": "SecureWiFi",
  "identity": "wdca-client-98214785.tsengsyu.com",
  "client_cert_pem": "-----BEGIN CERTIFICATE-----\nMIID...\n-----END CERTIFICATE-----",
  "private_key_pem": "-----BEGIN PRIVATE KEY-----\nMIIE...\n-----END PRIVATE KEY-----",
  "ca_cert_pem": "-----BEGIN CERTIFICATE-----\nMIID...\n-----END CERTIFICATE-----"
}
```

---

## Implementation

### Script: gen-tls-call.sh

Generates the complete tool call JSON from local certificate files.

```bash
#!/bin/bash
# Usage: ./scripts/gen-tls-call.sh <ssid> <identity> <client.crt> <client.key> <ca.crt> [output.json]

set -e

SSID="$1"
IDENTITY="$2"
CLIENT_CERT="$3"
PRIVATE_KEY="$4"
CA_CERT="$5"
OUTPUT="${6:-/tmp/tls-call.json}"

if [[ -z "$SSID" || -z "$IDENTITY" || -z "$CLIENT_CERT" || -z "$PRIVATE_KEY" || -z "$CA_CERT" ]]; then
  echo "Usage: $0 <ssid> <identity> <client.crt> <client.key> <ca.crt> [output.json]"
  exit 1
fi

# Read and escape PEM content for JSON
read_pem() {
  cat "$1" | jq -Rs .
}

cat > "$OUTPUT" << EOF
{
  "ssid": "$SSID",
  "identity": "$IDENTITY",
  "client_cert_pem": $(read_pem "$CLIENT_CERT"),
  "private_key_pem": $(read_pem "$PRIVATE_KEY"),
  "ca_cert_pem": $(read_pem "$CA_CERT")
}
EOF

echo "Generated: $OUTPUT"
echo "Tell AI: Call wifi_connect_tls with params from $OUTPUT"
```

### cert-manager.ts - No Changes

Keep existing implementation for temp file handling.

### wifi_connect_tls Tool - No Changes

Keep existing implementation with PEM parameters.

---

## Files to Modify

| File | Changes |
|------|---------|
| `scripts/gen-tls-call.sh` | **NEW** - Script to generate tool call JSON |

No changes needed to existing implementation.

---

## Usage

### Step 1: Generate Tool Call (instant)

```bash
./scripts/gen-tls-call.sh \
  "SecureWiFi" \
  "wdca-client-98214785.tsengsyu.com" \
  ./client.crt \
  ./client.key \
  ./ca.crt

# Output: Generated: /tmp/tls-call.json
```

### Step 2: Tell AI to Execute

```
User: "Call wifi_connect_tls with params from /tmp/tls-call.json"

AI: [reads JSON, calls tool with params - fast]
```

---

## Testing

### Verify Generated JSON

```bash
cat /tmp/tls-call.json | jq .
```

### Verify Connection

```bash
wpa_cli status
# Should show: key_mgmt=WPA-EAP, EAP state=SUCCESS
```

---

## Error Handling

| Error | Message | Resolution |
|-------|---------|------------|
| File not found | `client_cert not found: /path/to/cert` | Check file path |
| Permission denied | `Cannot read private_key: permission denied` | Check file permissions |
| Invalid cert | `EAP-TLS: Failed to initialize` | Check cert format |
| CA validation failed | `EAP-TLS: Server cert validation failed` | Check CA cert |

---

## References

- [wpa_supplicant EAP-TLS](https://w1.fi/cgit/hostap/plain/wpa_supplicant/wpa_supplicant.conf)
- [IEEE 802.1X-2020](https://standards.ieee.org/standard/802_1X-2020.html)
